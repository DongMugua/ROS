
### 状态机简介  
状态机能够根据控制信号按照预先设定的状态进行状态转移，是协调相关信号动作,完成特定操作的控制中心。说的通俗一点就是状态转移图，节点在这个图状态之间转换。

BodyHub实现了一个自定义的状态机，用来管理上层节点对其部分服务的请求。
### BodyHub节点功能
- 主要功能：根据上层节点给的数据控制机器人舵机，实现机器人运动控制
- 次要功能：获取机器人传感器数据，发布数据；根据上层指令，控制机器人上的执行器

BodyHub节点会优先保证主要功能的实现，我们使用的是次要功能。
### BodyHub状态机作用
BodyHub节点的服务是独占的，同一时刻只能响应一个上层节点的请求，为避免BodyHub节点在处理某个请求时被其他节点的请求干扰，我们使用了状态机进行管理。
### BodyHub节点状态机状态表
下述`节点`表示`BodyHub节点`，`占用节点`、`主要功能节点`、`次要功能节点`指上层节点
- init ：节点正在初始化
- preReady : 节点处于空闲状态，等待被占用
- ready : 节点被占用，占用节点获得控制权
- running : 节点响应完主要功能节点的请求，等待处理
- pause : 节点处理完主要功能节点的请求,等待下一个请求
- stoping : 主要功能节点释放节点的控制权，释放后节点会自动跳转到preReady状态
- directOperate : 节点正在响应次要功能节点的请求
- error : 节点出错
#### 主要功能与状态
控制机器人实质是控制机器人的舵机，控制分两组，分别是全身关节的舵机控制和头部舵机的控制。BodyHub节点订阅了`/MediumSize/BodyHub/MotoPosition`和`/MediumSize/BodyHub/HeadPosition`话题发布的消息，前者用于全身关节控制，后者用于头部单独控制。下面会简要分析关节的控制，头部的控制和关节基本相同。

 在关节控制中，假设上层控制节点已经获取BodyHub节点节的控制权[^脚注1]。节点收到话题的消息后会将消息附带的舵机控制数据放入队列，并将节点设置为`running`状态，此状态下会检测队列中的数据是否被处理，若处理完成（队列为空），会将状态自动设置为`pause`。
#### 话题与状态
 BodyHub节点发生状态切换会发布`/MediumSize/BodyHub/Status`话题，话题消息包含节点切换后的状态，可通过此话题获知节点的状态变化。
### BodyHub节点状态机的使用
使用节点状态机其实就是向节点发送请求，在
- 获取传感器数据
- 控制执行器

时，都是通过向BodyHub节点发送请求实现的
#### 占用节点
以下内容假设占用id设置为6
1. 向BodyHub节点的`/MediumSize/BodyHub/StateJump`服务发送`setStatus`请求，请求占用；
命令：`rosservice call /MediumSize/BodyHub/StateJump 6 setStatus`；
2. 若BodyHub节点占用id不为0，则返回被占用id。若为0，设置请求的占用id并返回`ready`状态，此时BodyHub节被占用成功。
#### 使用节点
BodyHub节点被成功占用时，可使用节点执行相关操作。
#### 释放节点
释放节点的占用和占用基本一样，向`/MediumSize/BodyHub/StateJump`服务发送释放请求即可[^脚注2]。

[^脚注1]:详细参考BodyHub节点状态机的使用部分
[^脚注2]:详细服务可参考BodyHub的服务和话题文档